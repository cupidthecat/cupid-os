>comment CupidMark converted document
>h1 CupidOS Filesystems and FAT16
Verified against source on: 2026-02-13
>style bg #F7F4EC
>style body #1A1A1A
>style h1 #B03060
>style h2 #2B4FA8
>style h3 #9A5A00
>style rule #B8B1A3
>style box #EEE7D8
>style boxtext #223355
>style link #1D4ED8
>style linkhover #0B3AA8
>rule

>h2 Mount Layout
CupidOS initializes these mounts:

/      -> ramfs
/dev   -> devfs
/home  -> fat16 (if ATA disk is present and FAT16 init succeeds)

Boot/storage model (current):
- Single HDD image: cupidos.img
- MBR + bootloader + kernel + FAT16 partition in one file
- /home is mounted from that FAT16 partition (persistent)

Build sizing controls:
- make HDD_MB=100
- make HDD_MB=200
- Default is HDD_MB=200

Persistence behavior:
- make and make run reuse existing cupidos.img
- make clean keeps cupidos.img
- make clean-image removes only cupidos.img
- make distclean removes build artifacts and cupidos.img

>h2 Standard Directories Created At Boot
/bin
/docs
/docs/demos
/demos
/tmp
/home

>h2 RAMFS VS FAT16
RAMFS (/):
- In-memory, non-persistent
- Good for temporary runtime files in current session
- /bin is populated at boot with built-in stubs and embedded .cc command files

FAT16 (/home):
- Persistent disk-backed storage (disk image / real disk)
- Intended for user files and user programs
- Mounted via VFS FAT16 wrapper

Demo sources:
- Embedded at boot under /demos/*.asm
- Mirrored under /docs/demos/*.asm for docs-relative open paths

DEVFS (/dev):
- Device filesystem mount

>h2 In-Memory File Table (Legacy Static Files)
Kernel static fs entries currently include:
- LICENSE.txt
- MOTD.txt

They are loaded into ramfs during boot.

>h2 FAT16 Driver Reality (Current Implementation)
Implemented:
- FAT16 partition detection from MBR (first matching FAT16 partition type)
- File open/read/close
- File create/write/overwrite
- File delete
- Root directory enumeration
- Root-level directory create (mkdir)
- Subdirectory enumeration for directories directly under FAT16 root

Important practical limitations:
- 8.3 naming model is enforced by FAT filename conversion routines.
- Wrapper still behaves mostly like flat root for file opens/writes.
- Creating files inside subdirectories through VFS path "dir/file.txt"
  is not a reliable workflow yet.
- Best-supported workflow today: keep user files and scripts in /home root,
  and user command sources in /home/bin.

>h2 Write Path Details
FAT16 VFS write path buffers output and rewrites whole file on close.
If write fails, rollback attempts to restore original content.

>h2 Block Cache
Disk I/O goes through block cache.
Useful commands:
- sync       : flush cache now
- cachestats : print cache hit/miss statistics

Demo sync workflow:
- make sync-demos copies local demos/*.asm into /home/demos
- This updates the persistent FAT16 partition inside cupidos.img

>h2 Persistent Program Workflow
Place custom command sources in:
  /home/bin/<name>.cc
Then run:
  <name>
Shell auto-discovers and JIT-compiles from /home/bin.

>h2 Path Safety Tips
- Use absolute paths when learning:
    /home/myfile.txt
    /tmp/test.txt
- Use pwd frequently.
- Verify with:
    ls
    cat
    mount

>h2 Where To Put These Doc Files In A Live System
If you want docs readable inside running CupidOS:
- Put copies in /home (persistent) or /tmp (session only).
- /home is recommended for long-term docs.

Host-to-/home copy quick commands (mtools):
  mcopy -o -i cupidos.img@@2097152 file.txt ::/file.txt
  mdir  -i cupidos.img@@2097152 ::/

Mapping reminder:
- FAT root ::/ maps to CupidOS /home.
- So ::/cupid.bmp appears as /home/cupid.bmp in CupidOS.

>h2 See Also
01SHELL.TXT for path resolution behavior
04CUPIDC.TXT and 05ELFPROG.TXT for program placement conventions

